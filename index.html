<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🧮 Calcul Mental - Collège</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary-light: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      --success: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      --warning: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      --danger: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
      --card: #ffffff;
      --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --text: #2d3748;
      --text-light: #718096;
      --border: #e2e8f0;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .app {
      width: min(1200px, 100%);
      animation: slideUp 0.8s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--card);
      border-radius: 24px;
      padding: 40px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: var(--primary);
    }

    h1 {
      font-size: clamp(28px, 4vw, 36px);
      font-weight: 800;
      margin-bottom: 16px;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    }

    h2 {
      font-size: clamp(20px, 3vw, 24px);
      font-weight: 700;
      margin: 24px 0 12px 0;
      color: var(--text);
    }

    .lead {
      color: var(--text-light);
      margin-bottom: 32px;
      font-size: 18px;
      text-align: center;
      font-weight: 500;
    }

    .themes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .theme-item {
      display: flex;
      align-items: center;
      gap: 16px;
      background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .theme-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--primary-light);
      transition: left 0.5s ease;
      z-index: 0;
    }

    .theme-item:hover::before {
      left: 0;
    }

    .theme-item:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: transparent;
    }

    .theme-item input {
      width: 24px;
      height: 24px;
      accent-color: #667eea;
      cursor: pointer;
      z-index: 1;
      position: relative;
    }

    .theme-item span {
      font-weight: 600;
      font-size: 16px;
      z-index: 1;
      position: relative;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
    }

    button {
      appearance: none;
      border: 0;
      background: var(--primary);
      color: white;
      padding: 16px 24px;
      border-radius: 16px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-width: 120px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.6s ease;
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-outline {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-outline:hover {
      background: #667eea;
      color: white;
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-muted {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%);
      color: var(--text);
    }

    .btn-muted:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .seg {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .seg button {
      background: white;
      color: #667eea;
      border: 2px solid #e2e8f0;
      min-width: 80px;
      padding: 12px 20px;
    }

    .seg button.active {
      background: var(--primary);
      color: white;
      border-color: transparent;
      transform: scale(1.05);
    }

    .progress {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--text-light);
    }

    .bar {
      position: relative;
      height: 12px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
      flex: 1;
    }

    .bar > span {
      position: absolute;
      inset: 0;
      width: 0%;
      background: var(--primary);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 999px;
    }

    .q {
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      margin: 20px 0;
      text-align: center;
      color: var(--text);
    }

    .subq {
      color: var(--text-light);
      margin-bottom: 20px;
      font-size: 16px;
      text-align: center;
      font-weight: 500;
    }

    .choices {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 32px 0;
    }

    .choice {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 3px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .choice::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--primary-light);
      transition: left 0.3s ease;
      z-index: 0;
    }

    .choice:hover::before {
      left: 0;
    }

    .choice:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: #667eea;
    }

    .choice span {
      position: relative;
      z-index: 1;
    }

    .choice.correct {
      background: var(--success);
      border-color: #84fab0;
      color: #065f46;
      animation: pulse 0.6s ease;
    }

    .choice.wrong {
      background: var(--danger);
      border-color: #ff9a9e;
      color: #991b1b;
      animation: shake 0.6s ease;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .timer {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      padding: 12px 20px;
      background: var(--success);
      border-radius: 50px;
      color: #065f46;
      transition: all 0.3s ease;
    }

    .timer .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #065f46;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    .timer.warn {
      background: var(--warning);
      color: #92400e;
    }

    .timer.warn .dot {
      background: #92400e;
    }

    .timer.urgent {
      background: var(--danger);
      color: #991b1b;
      animation: shake 0.5s infinite;
    }

    .timer.urgent .dot {
      background: #991b1b;
    }

    .footer-actions {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 32px;
      align-items: center;
      justify-content: center;
    }

    .answer-box {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin: 32px 0;
    }

    input.answer {
      font-size: 24px;
      padding: 16px 20px;
      border-radius: 16px;
      border: 3px solid var(--border);
      background: white;
      color: var(--text);
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      min-width: 180px;
    }

    input.answer:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: scale(1.02);
    }

    .kbd {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .kbd button {
      padding: 20px 16px;
      font-size: 20px;
      font-weight: 700;
      border-radius: 16px;
      background: white;
      color: var(--text);
      border: 2px solid var(--border);
      min-width: 0;
    }

    .kbd button:hover {
      background: var(--primary);
      color: white;
      border-color: transparent;
    }

    .frac {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 32px;
      font-weight: 700;
    }

    .frac input {
      width: 120px;
    }

    .countdown {
      font-size: 48px;
      font-weight: 800;
      background: var(--primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      animation: bounce 1s infinite;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      padding: 20px 0;
      border-bottom: 2px dashed var(--border);
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 14px;
    }

    .pill.good {
      background: var(--success);
      color: #065f46;
    }

    .pill.bad {
      background: var(--danger);
      color: #991b1b;
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .card {
        padding: 24px;
        border-radius: 20px;
      }

      .themes {
        grid-template-columns: 1fr;
      }

      .choices {
        grid-template-columns: 1fr;
      }

      .row {
        justify-content: center;
      }

      .footer-actions {
        justify-content: center;
      }
    }

    /* Animation d'entrée pour les éléments */
    .theme-item,
    .choice,
    .seg button {
      animation: slideInUp 0.6s ease forwards;
      opacity: 0;
    }

    .theme-item:nth-child(1) { animation-delay: 0.1s; }
    .theme-item:nth-child(2) { animation-delay: 0.2s; }
    .theme-item:nth-child(3) { animation-delay: 0.3s; }
    .theme-item:nth-child(4) { animation-delay: 0.4s; }
    .theme-item:nth-child(5) { animation-delay: 0.5s; }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="view" class="card"></div>
  </div>

<script>
// Utils
const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const sample = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
const gcd=(a,b)=>b?gcd(b,a%b):Math.abs(a);
const simplifyFrac=(n,d)=>{const g=gcd(n,d);return [n/g,d/g]};
const compareFrac=(a,b,c,d)=>a*d-b*c;
const el=(s)=>document.querySelector(s);
const setView=(h)=>{el('#view').innerHTML=h};
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

// Themes (15)
const THEMES=[
  { key:'mult_lt_10',  label:'🔢 Multiplications < 10' },
  { key:'add_carry',   label:'➕ Additions avec retenue' },
  { key:'decimals',    label:'🔟 Décimaux simples' },
  { key:'integers',    label:'➖ Relatifs (±)' },
  { key:'fractions',   label:'🧮 Fractions à simplifier' },
  { key:'mult_lt_20',  label:'✖️ Multiplications < 20' },
  { key:'div_int_easy',label:'➗ Divisions entières facilement' },
  { key:'squares_roots',label:'⬛ Carrés & √ exactes' },
  { key:'perc_simple', label:'% simples (10,20,25,50)' },
  { key:'perc_est',    label:'% ordre de grandeur' },
  { key:'frac_compare',label:'⇅ Comparer des fractions' },
  { key:'frac_add_same',label:'➕ Fractions : même dénominateur' },
  { key:'dec_pow10',   label:'🔟 Décimaux × 10/100/1000' },
  { key:'equations',   label:'Équations simples' },
  { key:'rel_proddiv', label:'± Relatifs : × et ÷' },
];

// Generators (same as version mix)
function genQuestion(themeKey){
  switch(themeKey){
    case 'mult_lt_10':{
      const a=rnd(2,9), b=rnd(2,9), correct=a*b;
      const cand=new Set([correct]);
      while(cand.size<4){ const d=sample([-6,-4,-3,-2,-1,1,2,3,4,6]); cand.add(Math.max(0,correct+d)); }
      const choices=shuffle([...cand]); return {theme:themeKey,prompt:`${a} × ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'add_carry':{
      const base=[rnd(10,99),rnd(100,999)][Math.random()<0.5?0:1];
      const mod=[-1,-2,-3,-4,-5,-6,-7,-8,-9][rnd(0,8)];
      const a=base-(base%10)+(10+mod), add=rnd(2,9), correct=a+add;
      const choices=shuffle([correct,correct-1,correct+1,a+10]);
      return {theme:themeKey,prompt:`${a} + ${add} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'decimals':{
      const a=(rnd(10,150)/10).toFixed(1), b=(rnd(5,100)/10).toFixed(1), op=Math.random()<0.5?'+':'−';
      const av=parseFloat(a), bv=parseFloat(b);
      const correct=parseFloat((op==='+'?av+bv:av-bv).toFixed(1));
      const choices=shuffle([correct,parseFloat((correct+0.1).toFixed(1)),parseFloat((correct-0.1).toFixed(1)),parseFloat((op==='+'? av+(bv+1): av-(bv-1)).toFixed(1))]);
      return {theme:themeKey,prompt:`${a} ${op} ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'decimal1'};
    }
    case 'integers':{
      const a=rnd(-20,20), b=rnd(-20,20), op=Math.random()<0.5?'+':'−';
      const correct=op==='+'?a+b:a-b;
      const choices=shuffle([correct,correct+1,correct-1,-correct]);
      return {theme:themeKey,prompt:`${a} ${op} ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'fractions':{
      const a=rnd(2,9), b=rnd(2,9), k=rnd(2,9), n=a*k,d=b*k;
      const [sn,sd]=simplifyFrac(n,d); const correct=`${sn}/${sd}`;
      const choices=shuffle([correct,`${sn}/${Math.max(2,sd+1)}`,`${Math.max(1,sn+1)}/${sd}`,`${n}/${d}`]);
      return {theme:themeKey,prompt:`Simplifier ${n}/${d}`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'fraction'};
    }
    case 'mult_lt_20':{
      const a=rnd(6,19), b=rnd(6,19), correct=a*b;
      const near=[correct-a,correct+a,correct-b,correct+b], misc=[correct+sample([-3,-2,-1,1,2,3])];
      const pool=[correct,...near,...misc].filter((v,i,arr)=>arr.indexOf(v)===i && v>0).slice(0,4);
      const choices=shuffle(pool.length>=4?pool:[correct,correct-1,correct+1,correct+a]);
      return {theme:themeKey,prompt:`${a} × ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'div_int_easy':{
      const b=sample([2,3,4,5,6,7,8,9,10,12]), q=rnd(2,20), a=b*q, correct=q;
      const choices=shuffle([correct,q+1,q-1,q+2].filter((v,i,arr)=>arr.indexOf(v)===i && v>=0));
      return {theme:themeKey,prompt:`${a} ÷ ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'squares_roots':{
      if(Math.random()<0.5){
        const n=rnd(6,20), correct=n*n;
        const choices=shuffle([correct,(n-1)*(n-1),(n+1)*(n+1),correct+10]);
        return {theme:themeKey,prompt:`${n}² = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }else{
        const sq=sample([4,9,16,25,36,49,64,81,100,121,144,169,196,225,256,289,324,361,400]);
        const correct=Math.round(Math.sqrt(sq));
        const choices=shuffle([ correct, correct-1, correct+1, correct+2 ].filter(v=>v>0));
        return {theme:themeKey,prompt:`√${sq} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }
    }
    case 'perc_simple':{
      const pct=sample([10,20,25,50]), base=sample([40,80,100,120,160,200,240,400,500,800]);
      const correct=Math.round(base*pct/100);
      const choices=shuffle([correct,Math.round(base*(pct+10)/100),Math.round(base*(pct-10)/100),Math.round(base*0.5)]);
      return {theme:themeKey,prompt:`${pct}% de ${base} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'perc_est':{
      const pct=rnd(11,89), base=sample([100,200,300,400,500,800,1000]);
      const correct=Math.round(base*pct/100);
      const choices=shuffle([correct,Math.round(base*0.5),base,pct]);
      return {theme:themeKey,prompt:`${pct}% de ${base} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
    }
    case 'frac_compare':{
      const a=rnd(2,9), b=rnd(3,10), c=rnd(2,9), d=rnd(3,10);
      const left=`${a}/${b}`, right=`${c}/${d}`, cmp=compareFrac(a,b,c,d);
      const correct= cmp>0?left : (cmp<0?right:'égal');
      const choices=shuffle([left,right,'égal',cmp>0?right:left]);
      return {theme:themeKey,prompt:`Laquelle est la plus grande ? ${left} ou ${right}`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'pick_one'};
    }
    case 'frac_add_same':{
      const den=rnd(3,12), n1=rnd(1,den-1), n2=rnd(1,den-1), s=n1+n2;
      const [sn,sd]=simplifyFrac(s,den); const correct=`${sn}/${sd}`;
      const choices=shuffle([correct,`${s}/${den}`,`${sn}/${Math.max(2,sd+1)}`,`${Math.max(1,sn+1)}/${sd}`]);
      return {theme:themeKey,prompt:`${n1}/${den} + ${n2}/${den} = ? (forme simplifiée)`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'fraction'};
    }
    case 'dec_pow10':{
      const base=(rnd(10,999)/10), pow=sample([10,100,1000]); const correct=Number((base*pow).toFixed(1));
      const choices=shuffle([correct,Number((base*(pow/10)).toFixed(1)),Number((base*(pow*10)).toFixed(1)),Number((base*(pow-1)).toFixed(1))]);
      return {theme:themeKey,prompt:`${base.toFixed(1)} × ${pow} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'decimal1'};
    }
    case 'equations':{
      if(Math.random()<0.5){
        const a=rnd(2,20), b=rnd(5,40), x=b-a, correct=x;
        const choices=shuffle([correct,x+1,x-1,x+2]);
        return {theme:themeKey,prompt:`Résoudre : x + ${a} = ${b}`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }else{
        const k=sample([2,3,4,5,6,7,8,9]), x=rnd(2,20), b=k*x, correct=x;
        const choices=shuffle([correct,x+1,x-1,x+2]);
        return {theme:themeKey,prompt:`Résoudre : ${k}x = ${b}`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }
    }
    case 'rel_proddiv':{
      const a=rnd(-12,12), b=rnd(-12,12)||1, op=Math.random()<0.6?'×':'÷';
      if(op==='×'){ const correct=a*b;
        const choices=shuffle([correct,-a*b,correct+1,correct-1]);
        return {theme:themeKey,prompt:`${a} × ${b} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }else{
        const den=b===0?1:b, num=den*rnd(-12,12), correct=num/den;
        const choices=shuffle([correct,-correct,correct+1,correct-1]);
        return {theme:themeKey,prompt:`${num} ÷ ${den} = ?`,choices,correctIndex:choices.indexOf(correct),correctValue:correct,type:'int'};
      }
    }
  }
}

// State
let state={
  selectedThemes: [],
  mode:'qcm',
  secondsPerQ:15,
  numQuestions:10,
  questions:[],
  index:0,
  answers:[],
  timerId:null,
  timeLeft:0,
  recapId:null,
  recapLeft:0,
  fracFocus:'num'
};

// Screens
function renderHome(){
  setView(`
    <h1>🧮 Calcul Mental - Collège</h1>
    <p class="lead">Choisis un ou plusieurs thèmes et teste tes compétences en calcul mental !</p>
    <h2>🎯 Thèmes disponibles</h2>
    <div class="row" style="margin-bottom:20px">
      <button id="btn-all" class="btn-outline">Tout cocher</button>
      <button id="btn-none" class="btn-outline">Tout décocher</button>
      <button id="btn-basic" class="btn-outline">Pack collège (10)</button>
    </div>
    <div class="themes">
      ${THEMES.map((t,i)=>`
        <label class="theme-item">
          <input type="checkbox" class="tchk" data-key="${t.key}" ${i<5?'checked':''} />
          <span>${t.label}</span>
        </label>
      `).join('')}
    </div>
    <div class="grid" style="margin-top:32px">
      <div>
        <h2>🎮 Mode de réponse</h2>
        <div class="seg">
          <button id="m-qcm" class="active">QCM</button>
          <button id="m-free">Réponse libre</button>
        </div>
      </div>
      <div>
        <h2>⏱️ Temps par question</h2>
        <div class="seg" id="time-seg">
          ${[5,8,10,12,15,20].map(s=>`<button class="tbtn" data-s="${s}">${s}s</button>`).join('')}
          <button class="tbtn" data-s="custom">Libre…</button>
        </div>
      </div>
      <div>
        <h2>📊 Nombre de questions</h2>
        <div class="seg" id="count-seg">
          ${[5,10,15,20].map(n=>`<button class="cbtn" data-n="${n}">${n}</button>`).join('')}
        </div>
      </div>
      <div class="row">
        <button id="btn-start">🚀 Commencer</button>
      </div>
    </div>
  `);
  // preset buttons
  el('#btn-all').addEventListener('click', ()=> document.querySelectorAll('.tchk').forEach(c=>c.checked=true));
  el('#btn-none').addEventListener('click', ()=> document.querySelectorAll('.tchk').forEach(c=>c.checked=false));
  el('#btn-basic').addEventListener('click', ()=> {
    const keys = new Set(['mult_lt_10','add_carry','decimals','integers','fractions','perc_simple','equations','div_int_easy','squares_roots','dec_pow10']);
    document.querySelectorAll('.tchk').forEach(c=> c.checked = keys.has(c.dataset.key));
  });
  // mode
  el('#m-qcm').addEventListener('click', ()=>{ state.mode='qcm'; el('#m-qcm').classList.add('active'); el('#m-free').classList.remove('active'); });
  el('#m-free').addEventListener('click', ()=>{ state.mode='free'; el('#m-free').classList.add('active'); el('#m-qcm').classList.remove('active'); });
  // time
  el('#time-seg').querySelectorAll('.tbtn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const v=b.dataset.s;
      if(v==='custom'){
        const s = clamp(parseInt(prompt('Temps (3 à 60 s) :', String(state.secondsPerQ))||'15',10),3,60);
        state.secondsPerQ=s; highlightTimeBtn(null);
      }else{ state.secondsPerQ=parseInt(v,10); highlightTimeBtn(state.secondsPerQ); }
    });
  });
  function highlightTimeBtn(s){
    el('#time-seg').querySelectorAll('.tbtn').forEach(bb=>{
      const val = bb.dataset.s==='custom'? null : parseInt(bb.dataset.s,10);
      bb.classList.toggle('active', s!==null && val===s);
    });
  }
  highlightTimeBtn(15);
  // count
  el('#count-seg').querySelectorAll('.cbtn').forEach(b=>{
    b.addEventListener('click', ()=>{ state.numQuestions=parseInt(b.dataset.n,10); highlightCountBtn(state.numQuestions); });
  });
  function highlightCountBtn(n){
    el('#count-seg').querySelectorAll('.cbtn').forEach(bb=> bb.classList.toggle('active', parseInt(bb.dataset.n,10)===n));
  }
  highlightCountBtn(10);
  // start
  el('#btn-start').addEventListener('click', startFromHome);
}

function startFromHome(){
  const sel=[...document.querySelectorAll('.tchk')].filter(c=>c.checked).map(c=>c.dataset.key);
  if(sel.length===0){ alert('Choisis au moins un thème.'); return; }
  state.selectedThemes=sel;
  renderRecap();
}

function renderRecap(){
  state.recapLeft=5;
  setView(`
    <h1>🎯 Prêt à commencer ?</h1>
    <p class="lead">Tu vas jouer <strong>${state.numQuestions} questions</strong> de calcul mental !</p>
    <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); padding: 24px; border-radius: 16px; margin: 24px 0;">
      <ul style="list-style: none; padding: 0; margin: 0;">
        <li style="margin: 12px 0; font-size: 16px;">🎯 Thèmes sélectionnés : <strong>${state.selectedThemes.map(labelForTheme).join(', ')}</strong></li>
        <li style="margin: 12px 0; font-size: 16px;">🎮 Mode : <strong>${state.mode==='qcm'?'QCM':'Réponse libre'}</strong></li>
        <li style="margin: 12px 0; font-size: 16px;">⏱️ Temps par question : <strong>${state.secondsPerQ} s</strong></li>
      </ul>
    </div>
    <p class="countdown" id="countdown">Démarrage dans ${state.recapLeft}…</p>
    <div class="footer-actions">
      <button id="btn-cancel" class="btn-muted">❌ Annuler</button>
      <button id="btn-skip" class="btn-outline">🚀 Démarrer maintenant</button>
    </div>
  `);
  const cd=()=>{ const c=el('#countdown'); if(c) c.textContent=`Démarrage dans ${state.recapLeft}…`; };
  cd();
  state.recapId=setInterval(()=>{
    state.recapLeft--; cd();
    if(state.recapLeft<=0){ clearInterval(state.recapId); startQuiz(); }
  },1000);
  el('#btn-cancel').addEventListener('click', renderHome);
  el('#btn-skip').addEventListener('click', startQuiz);
}

function startQuiz(){
  clearTimers();
  state.index=0; state.answers=[]; state.questions=[];
  for(let i=0;i<state.numQuestions;i++){
    const tk= sample(state.selectedThemes);
    const q = genQuestion(tk);
    state.questions.push(q);
  }
  renderQuestion();
}

function renderQuestion(){
  clearTimers();
  const q=state.questions[state.index];
  const progress=(state.index/state.questions.length)*100;
  setView(`
    <div class="progress">
      <div>Question ${state.index+1}/${state.questions.length} • ${state.mode==='qcm'?'QCM':'Réponse libre'}</div>
      <div class="bar" style="flex:1"><span style="width:${progress}%"></span></div>
    </div>
    <div class="subq">Thème : <strong>${labelForTheme(q.theme)}</strong></div>
    <div class="q">${q.prompt}</div>
    ${renderBody(q)}
    <div class="footer-actions">
      <div id="timer" class="timer"><span class="dot"></span><span id="tsec"></span></div>
      <button class="btn-outline" id="btn-home">🏠 Accueil</button>
    </div>
  `);
  el('#btn-home').addEventListener('click', renderHome);
  if(state.mode==='qcm' || q.type==='pick_one'){
    document.querySelectorAll('.choice').forEach(ch=> ch.addEventListener('click', ()=> chooseQCM(parseInt(ch.dataset.i,10)) ));
  }else{
    initKeypad(q.type==='fraction');
  }
  startTimer();
}

function renderBody(q){
  if(state.mode==='qcm' || q.type==='pick_one'){
    const arr=q.choices && q.choices.length?q.choices:[q.correctValue, q.correctValue+1, q.correctValue-1, q.correctValue+2];
    return `<div class="choices">${arr.map((c,i)=>`<div class="choice" data-i="${i}"><span>${c}</span></div>`).join('')}</div>`;
  }else{
    if(q.type==='fraction'){
      return `
        <div class="answer-box">
          <div class="frac">
            <input id="num" class="answer" type="text" inputmode="numeric" placeholder="numérateur" />
            <span>/</span>
            <input id="den" class="answer" type="text" inputmode="numeric" placeholder="dénominateur" />
          </div>
        </div>
        ${renderKeypad(true)}
      `;
    }else{
      return `
        <div class="answer-box">
          <input id="free" class="answer" type="text" inputmode="decimal" placeholder="Ta réponse" />
        </div>
        ${renderKeypad(false)}
      `;
    }
  }
}

function renderKeypad(isFraction){
  return `
  <div class="kbd">
    <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
    <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
    <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
    <button data-k="0">0</button><button data-k=",">,</button><button data-k="+/-">+/-</button>
    <button data-k="back" class="btn-outline">⌫ Effacer</button>
    <button data-k="ok">✅ Valider</button>
    ${isFraction?'<button data-k="swap" class="btn-outline">↕ num / den</button>':'<span></span>'}
  </div>`;
}

function initKeypad(isFraction){
  const input=el('#free'); const num=el('#num'), den=el('#den');
  if(isFraction){ num.addEventListener('focus',()=>state.fracFocus='num'); den.addEventListener('focus',()=>state.fracFocus='den'); state.fracFocus='num'; }
  document.querySelectorAll('.kbd button').forEach(b=>{
    b.addEventListener('click',()=>{
      const k=b.dataset.k;
      if(k==='ok'){ chooseFree(); return; }
      if(k==='back'){ if(isFraction){ const t=state.fracFocus==='num'?num:den; t.value=t.value.slice(0,-1); } else { input.value=input.value.slice(0,-1); } return; }
      if(k==='swap' && isFraction){ state.fracFocus=state.fracFocus==='num'?'den':'num'; (state.fracFocus==='num'?num:den).focus(); return; }
      if(k==='+/-'){ if(!isFraction){ if(input.value.startsWith('-')) input.value=input.value.slice(1); else input.value='-'+input.value; } return; }
      if(isFraction){ if(k===',') return; const t=state.fracFocus==='num'?num:den; t.value+=k; } else { input.value+=k; }
    });
  });
}

function startTimer(){
  state.timeLeft=state.secondsPerQ; updateTimerUI();
  state.timerId=setInterval(()=>{
    state.timeLeft--; updateTimerUI();
    if(state.timeLeft<=0){ clearTimers();
      const q=state.questions[state.index];
      if(state.mode==='qcm' || q.type==='pick_one'){ recordAnswer({choiceIndex:-1,isCorrect:false,timedOut:true}); }
      else { recordAnswer({freeValue:null,isCorrect:false,timedOut:true}); }
      advance();
    }
  },1000);
}

function updateTimerUI(){
  const t=el('#timer'); if(!t) return;
  el('#tsec').textContent=`${state.timeLeft}s restantes`;
  t.classList.toggle('warn', state.timeLeft <= Math.ceil(state.secondsPerQ/2) && state.timeLeft > Math.ceil(state.secondsPerQ/5));
  t.classList.toggle('urgent', state.timeLeft <= Math.ceil(state.secondsPerQ/5));
}

function clearTimers(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
  if(state.recapId){ clearInterval(state.recapId); state.recapId=null; }
}

function chooseQCM(i){
  clearTimers();
  const q=state.questions[state.index]; const correct=q.correctIndex; const isCorrect=i===correct;
  document.querySelectorAll('.choice').forEach((ch,idx)=>{
    ch.classList.remove('correct','wrong');
    if(idx===correct) ch.classList.add('correct');
    if(idx===i && idx!==correct) ch.classList.add('wrong');
    ch.style.pointerEvents='none';
  });
  recordAnswer({choiceIndex:i,isCorrect,timedOut:false}); setTimeout(advance,800);
}

function parseFree(q){
  if(q.type==='fraction'){
    const n=(el('#num').value||'').trim(); const d=(el('#den').value||'').trim();
    if(!n||!d) return null; return `${parseInt(n,10)||0}/${parseInt(d,10)||0}`;
  }else{
    let v=(el('#free').value||'').trim(); if(v==='') return null; v=v.replace(',', '.'); const num=Number(v);
    if(Number.isNaN(num)) return null; if(q.type==='decimal1') return Number(num.toFixed(1)); if(q.type==='int') return Math.trunc(num); return num;
  }
}

function chooseFree(){
  clearTimers();
  const q=state.questions[state.index]; const user=parseFree(q);
  let isCorrect=false; if(q.type==='fraction'){ isCorrect = user===q.correctValue; } else { isCorrect = Number(user)===Number(q.correctValue); }
  recordAnswer({freeValue:user,isCorrect,timedOut:false}); setTimeout(advance,200);
}

function recordAnswer(obj){
  const q=state.questions[state.index];
  state.answers.push({ choiceIndex: obj.choiceIndex ?? -1, correctIndex: q.correctIndex ?? null, isCorrect: !!obj.isCorrect, timedOut: !!obj.timedOut, freeValue: obj.freeValue ?? null, theme:q.theme });
}

function advance(){
  state.index++; if(state.index>=state.questions.length) renderResult(); else renderQuestion();
}

function renderResult(){
  const total=state.answers.filter(a=>a.isCorrect).length;
  const percentage = Math.round((total/state.questions.length)*100);
  setView(`
    <h1>🎉 Résultat</h1>
    <p class="lead">Score : <strong>${total}/${state.questions.length}</strong> (${percentage}%)</p>
    <div style="text-align: center; margin: 24px 0;">
      ${percentage >= 80 ? '🏆 Excellent !' : percentage >= 60 ? '👍 Bien joué !' : percentage >= 40 ? '💪 Continue tes efforts !' : '📚 Il faut réviser !'}
    </div>
    <div class="grid">
      ${state.questions.map((q,idx)=>{
        const a=state.answers[idx];
        const user = a.freeValue!=null ? a.freeValue : (a.choiceIndex>=0 ? q.choices[a.choiceIndex] : '—');
        const corr = q.type==='decimal1' ? Number(q.correctValue).toFixed(1) : q.correctValue;
        const info = a.timedOut ? '⏳ temps écoulé' : (a.isCorrect ? '✓' : '✗');
        return `
        <div class="result-row">
          <div><strong>Q${idx+1}.</strong> [${labelForTheme(a.theme)}] ${q.prompt}</div>
          <div>${a.isCorrect ? `<span class="pill good">${info} ${corr}</span>` : `<span class="pill bad">${info} ${user}</span> <span class="pill good">→ ${corr}</span>`}</div>
        </div>`;
      }).join('')}
    </div>
    <div class="footer-actions" style="margin-top:32px">
      <button id="btn-retry" class="">🔄 Rejouer (mêmes thèmes)</button>
      <button id="btn-accueil" class="btn-muted">🏠 Revenir à l'accueil</button>
    </div>
  `);
  el('#btn-retry').addEventListener('click', ()=> renderRecap());
  el('#btn-accueil').addEventListener('click', renderHome);
}

function labelForTheme(key){
  const t=THEMES.find(x=>x.key===key); return t? t.label: key;
}

// start
renderHome();
</script>
</body>
</html>